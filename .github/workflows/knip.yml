name: Knip - Unused Code Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  knip:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node and Install Dependencies
        uses: ./.github/actions/setup-node-and-install

      - name: Run knip
        id: knip
        continue-on-error: true
        env:
          NO_COLOR: 1
        run: |
          set +e
          OUTPUT=$(pnpm knip --no-config-hints 2>&1)
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Save output to file for multiline handling (strip any remaining ANSI codes)
          echo "$OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' > knip-output.txt

          # Check if there are any issues
          if [ $EXIT_CODE -eq 0 ]; then
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

      - name: Create comment body
        id: comment
        env:
          HAS_ISSUES: ${{ steps.knip.outputs.has_issues }}
        run: |
          if [ "$HAS_ISSUES" = "true" ]; then
            {
              echo 'body<<EOF'
              echo '## ğŸ” Knip - Unused Code Detection'
              echo ''
              echo 'ä»¥ä¸‹ã®æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼š'
              echo ''
              echo '```'
              cat knip-output.txt
              echo '```'
              echo ''
              echo '<details>'
              echo '<summary>å¯¾å¿œæ–¹æ³•</summary>'
              echo ''
              echo '- **æœªä½¿ç”¨ã®ä¾å­˜é–¢ä¿‚**: `pnpm remove <package>` ã§å‰Šé™¤'
              echo '- **æœªä½¿ç”¨ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã‹ã€`knip.config.ts` ã® `ignore` ã«è¿½åŠ '
              echo '- **æœªä½¿ç”¨ã®å‹**: å‹å®šç¾©ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€å°†æ¥ä½¿ç”¨äºˆå®šãªã‚‰ `knip.config.ts` ã§é™¤å¤–'
              echo ''
              echo '</details>'
              echo ''
              echo '---'
              echo '*ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è­¦å‘Šã®ã¿ã§ã€ãƒãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ã€‚*'
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            {
              echo 'body<<EOF'
              echo '## ğŸ” Knip - Unused Code Detection'
              echo ''
              echo 'âœ… æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚'
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: knip-report
          message: ${{ steps.comment.outputs.body }}
