# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Pre-Pull Request Requirements

Before creating any pull request, you MUST run the following commands and ensure they pass:

```bash
# Install dependencies
yarn install

# Run linting and type checking
yarn lint

# Run tests
yarn test
```

## Development Commands

### Essential Commands
- `yarn dev` - Start development environment with hot reload
- `yarn lint` - Run all linting (biome + TypeScript + actionlint)
- `yarn lint:fix` - Auto-fix biome issues and run type checking
- `yarn test` - Run all tests
- `yarn build` - Create production build
- `yarn dist` - Build and package for distribution

### Testing Commands
- `yarn test:web` - Run frontend tests (Vitest with jsdom)
- `yarn test:electron` - Run Electron/Node tests (Vitest with node)
- `yarn test:playwright` - Run E2E tests (requires build first)

### Development Utilities
- `yarn generate:debug-data` - Generate debug data for development
- `yarn license-check:generate` - Generate license info (updates src/assets/licenses.json)

## High-Level Architecture

This is an Electron desktop application for organizing VRChat photos by automatically associating them with log files to track when and where photos were taken.

### Tech Stack
- **Desktop Framework**: Electron
- **Frontend**: React 18 + TypeScript
- **Build Tool**: Vite
- **API Layer**: tRPC for type-safe communication between main/renderer processes
- **Database**: SQLite with Sequelize ORM
- **UI**: Tailwind CSS + Radix UI components

### Project Structure
```
/electron/        # Main process (Node.js/Electron)
  /api.ts        # tRPC router definition - all API endpoints
  /index.ts      # Main entry point
  /lib/          # Core utilities (DB, logging, file system wrappers)
  /module/       # Business logic modules (VRChat logs, photos, settings)
  
/src/            # Renderer process (React)
  /v2/           # Main app code
    /components/ # React components
    /hooks/      # Custom React hooks
    /i18n/       # Internationalization (Japanese/English)
  /components/ui/ # Shadcn UI components
```

### Key Architectural Patterns

1. **tRPC Communication**: All communication between Electron main and renderer processes goes through tRPC routers defined in `electron/api.ts`

2. **Error Handling**: 
   - Service layer uses neverthrow Result pattern for detailed error handling
   - tRPC layer uses UserFacingError pattern for user-friendly messages
   - Helper functions in `electron/lib/errorHelpers.ts` bridge Result types to UserFacingErrors

3. **Database Access**: 
   - Sequelize models in `/electron/module/*/model.ts` files
   - Services wrap DB operations with Result types for error handling
   - DB queue system prevents concurrent write issues

4. **Photo Processing**:
   - EXIF data extraction using exiftool-vendored
   - Image processing with sharp for thumbnails
   - Automatic association with VRChat log files based on timestamps

## Important Guidelines

### File Modification Rules
- Never modify automatically generated files:
  - `src/assets/licenses.json` (generated by license-check:generate)
  - `yarn.lock` (managed by Yarn)
  - `CHANGELOG.md` (generated by git-cliff)
  - Files in `debug/` directory

### Code Style
- Docstrings should be written in Japanese
- Use TypeScript strict mode
- Follow existing patterns in the codebase
- TypeScript decorators are enabled for Sequelize models

### Development Workflow
1. Make your changes
2. Run `yarn lint:fix` to automatically fix formatting issues
3. Run `yarn lint` to ensure no remaining issues
4. Run `yarn test` to ensure tests pass
5. Only then create/update pull requests

## Environment Requirements
- Node.js 20 (required)
- Yarn 4 (required - this project uses Yarn Modern)
- Pre-commit hooks run `yarn lint` automatically